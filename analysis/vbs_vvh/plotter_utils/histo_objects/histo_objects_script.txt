#base.py
import numpy as np
import copy
import ewkcoffea.modules.plotting_tools as plt_tools


class BaseHist:
    """
    Base class that handles transformations common to
    signal / background / data histograms.

    This class:
      - sums over years
      - groups raw processes into physics groups
      - exposes basic histogram information
      - provides a safe way to merge overflow bins
    """

    def __init__(
        self,
        hist,
        *,
        years,
        process_grouping,
    ):
        self._raw_hist = hist
        self.years = years
        self.process_grouping = process_grouping

        # Prepare the final histogram immediately
        self._hist = self._prepare_hist()

    # ------------------------------------------------------------------
    # Core transformation pipeline
    # ------------------------------------------------------------------

    def _prepare_hist(self):
        """
        Apply transformations common to all histogram types.
        """
        h = self._raw_hist

        # 1) Sum over years
        h = self._sum_years(h)

        # 2) Group raw processes into physics processes
        h = self._group_processes(h)

        return h

    def _safe_merge_overflow(self, h, axis_slice=None):
        """
        Call merge_overflow safely:
          - optionally only on a subset of categories (axis_slice)
          - merge if dense axis has >= 2 bins
        """
        if axis_slice is not None:
            h = h[axis_slice]

        vals = h.values(flow=True)
        dense_bins = vals.shape[-1]

        if dense_bins >= 2:
            return plt_tools.merge_overflow(h)
        return h

    def _sum_years(self, h):
        """
        Collapse year axis into a single bin.
        """
        h = plt_tools.group(
            h,
            "year",
            "year_sum",
            {"all_years": self.years},
        )
        return h[{"year_sum": "all_years"}]

    def _group_processes(self, h):
        """
        Group raw MC samples into physics processes.
        """
        return plt_tools.group(
            h,
            "process",
            "process_grp",
            self.process_grouping,
        )

    # ------------------------------------------------------------------
    # Public accessors (used by plotting & metrics)
    # ------------------------------------------------------------------

    @property
    def hist(self):
        return self._hist

    def values(self, flow=True):
        return self._hist.values(flow=flow)

    def variances(self, flow=True):
        return self._hist.variances(flow=flow)

    def total_yield(self):
        return float(np.sum(self.values(flow=True)))

    def bin_edges(self):
        return self._hist.axes[0].edges

    def bin_centers(self):
        return self._hist.axes[0].centers


#signal.py
from plotter_utils.histo_objects.base import BaseHist


class SignalHist(BaseHist):
    """
    Signal histogram.

    Differences from BaseHist:
      - select ONLY signal process
      - select coupling-dependent systematic
    """

    def __init__(
        self,
        hist,
        *,
        years,
        process_grouping,
        coupling,
    ):
        self.coupling = coupling
        super().__init__(
            hist,
            years=years,
            process_grouping=process_grouping,
        )

    def _prepare_hist(self):
        h = super()._prepare_hist()

        # Select signal + coupling systematic
        h = h[
            {
                "process_grp": ["Signal"],
                "systematic": self.coupling,
            }
        ]

        # Safe merge overflow for signal
        h = self._safe_merge_overflow(h)
        return h

    def cumulative(self):
        return self.values(flow=False).cumsum()

#background.py
from plotter_utils.histo_objects.base import BaseHist
from plotter_utils.helpers.funcs import combine
import ewkcoffea.modules.plotting_tools as plt_tools


class BackgroundHist(BaseHist):
    """
    Background histogram.

    Differences from BaseHist:
      - always nominal systematic
      - keeps individual background process_grp for stacked plotting
      - provides total background histogram
    """

    def __init__(
        self,
        hist,
        *,
        years,
        process_grouping,
        background_groups,
    ):
        self.background_groups = background_groups
        super().__init__(
            hist,
            years=years,
            process_grouping=process_grouping,
        )

        # After preparing the histogram, generate the "total" histogram
        self._hist_total = self._make_total_background(self._hist)

    def _prepare_hist(self):
        import copy
        h = super()._prepare_hist()

        # Nominal only
        h = h[{"systematic": "nominal"}]

        # # Safe merge overflow **per process_grp**
        # hist_slices = {}
        # for proc in h.axes["process_grp"]:
        #     print(f'doing {proc}')
        #     hist_slices[proc] = self._safe_merge_overflow(h, {"process_grp": [proc]})
        # # Combine back
        # print(h)
        h = plt_tools.merge_overflow(h)
        #h = combine(hist_slices)
        return h

    def _make_total_background(self, h):
        """
        Collapse all background processes into one for total yield calculations.
        """
        h_total = plt_tools.group(
            h,
            "process_grp",
            "sample_category",
            {"Background": list(self.background_groups)},
        )
        h_total = self._safe_merge_overflow(h_total)
        return h_total

    @property
    def hist_total(self):
        """
        Collapsed total background histogram.
        """
        return self._hist_total

    def values_total(self, flow=True):
        return self._hist_total.values(flow=flow)

    def cumulative_total(self):
        return self.values_total(flow=False).cumsum()

    def cumulative(self):
        """
        Cumulative per-process background yield (stacked)
        """
        return self.values(flow=False).cumsum()

#data.py
from plotter_utils.histo_objects.base import BaseHist
from plotter_utils.helpers.funcs import combine
import ewkcoffea.modules.plotting_tools as plt_tools


class BackgroundHist(BaseHist):
    """
    Background histogram.

    Differences from BaseHist:
      - always nominal systematic
      - keeps individual background process_grp for stacked plotting
      - provides total background histogram
    """

    def __init__(
        self,
        hist,
        *,
        years,
        process_grouping,
        background_groups,
    ):
        self.background_groups = background_groups
        super().__init__(
            hist,
            years=years,
            process_grouping=process_grouping,
        )

        # After preparing the histogram, generate the "total" histogram
        self._hist_total = self._make_total_background(self._hist)

    def _prepare_hist(self):
        import copy
        h = super()._prepare_hist()

        # Nominal only
        h = h[{"systematic": "nominal"}]

        # # Safe merge overflow **per process_grp**
        # hist_slices = {}
        # for proc in h.axes["process_grp"]:
        #     print(f'doing {proc}')
        #     hist_slices[proc] = self._safe_merge_overflow(h, {"process_grp": [proc]})
        # # Combine back
        # print(h)
        h = plt_tools.merge_overflow(h)
        #h = combine(hist_slices)
        return h

    def _make_total_background(self, h):
        """
        Collapse all background processes into one for total yield calculations.
        """
        h_total = plt_tools.group(
            h,
            "process_grp",
            "sample_category",
            {"Background": list(self.background_groups)},
        )
        h_total = self._safe_merge_overflow(h_total)
        return h_total

    @property
    def hist_total(self):
        """
        Collapsed total background histogram.
        """
        return self._hist_total

    def values_total(self, flow=True):
        return self._hist_total.values(flow=flow)

    def cumulative_total(self):
        return self.values_total(flow=False).cumsum()

    def cumulative(self):
        """
        Cumulative per-process background yield (stacked)
        """
        return self.values(flow=False).cumsum()
